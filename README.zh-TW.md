[English](README.md)

---

# SillyTavern 提示詞分組摺疊擴充功能

將提示詞管理器中的項目，透過簡單的「標頭標記」分組為可摺疊區塊，讓清單更整齊、瀏覽更高效。

### 功能特色

- **可摺疊群組**: 將提示詞組織成可摺疊區塊，改善管理效率
- **雙模式摺疊**: 
  - 標準模式：從標題開始群組化所有後續項目，直到遇到下一個標題
  - 包覆模式：將配對標題之間的項目群組化
- **自訂分隔符號**: 定義專屬的群組標題符號
- **群組控制**: 關閉整個群組以阻止其內所有提示詞發送
- **狀態記憶**: 群組展開狀態會跨工作階段保存與還原
- **視覺回饋**: 已關閉的群組會以降低透明度顯示其狀態

### 安裝方式

1. 複製儲存庫連結：`https://github.com/lilminzyu/ST-PromptFolding`
2. 在 SillyTavern 介面中開啟【Extensions】分頁
3. 點擊右上角【Install Extension】
4. 在跳出的視窗中，將儲存庫連結貼到第一個輸入框
5. 點擊 **Install for all users** 或 **Install just for me**
6. 安裝完成後，前往【Manage Extensions】
7. 找到 **Prompt Folding** 並確保已啟用

### 使用方式

#### 基本設定

1. 開啟 SillyTavern 的提示詞管理器
2. 在標題區域找到 Prompt Folding 控制項：
   - 綠色/紅色圓圈：切換擴充功能開關
   - 向下箭頭：展開所有群組
   - 向上箭頭：收合所有群組
   - 齒輪圖示：開啟設定面板

#### 建立群組

**標準模式**（預設）：

建立一個標題提示詞，所有在此標題之後的提示詞都會被群組化，直到遇到下一個標題為止。

範例：
```
=== 區段 A ===
提示詞 1
提示詞 2
提示詞 3
=== 區段 B ===
提示詞 4
提示詞 5
```

結果：
```
=== 區段 A ===  [可展開]
  ├─ 提示詞 1
  ├─ 提示詞 2
  └─ 提示詞 3
=== 區段 B ===  [可展開]
  ├─ 提示詞 4
  └─ 提示詞 5
```

**包覆模式**：

使用兩個相同的標題包覆內容來建立群組。

範例：
```
==== 群組 A ====
提示詞 1
提示詞 2
==== 群組 A ====
提示詞 3
```

結果：
```
==== 群組 A ====  [可展開]
  ├─ 提示詞 1
  └─ 提示詞 2
提示詞 3  [未分組]
```

#### 自訂分隔符號

1. 點擊齒輪圖示開啟設定面板
2. 在文字區域中輸入自訂的分隔符號（每行一個）
3. 如有需要可開啟大小寫區分
4. 點擊【套用】儲存變更

預設分隔符號：`=` 和 `-`

任何以設定的分隔符號開頭的提示詞名稱都會被視為群組標題。此外，完全由符號和標點組成的提示詞會自動識別為標題。

#### 群組控制功能

當群組標題被關閉時，該群組內的所有提示詞都不會被發送到生成請求中，無論其個別的開關狀態為何。

視覺化說明：
```
=== 標題 A ===  [toggle: ON]
  ├─ 項目 1 [toggle: ON]      ← 會發送
  ├─ 項目 2 [toggle: OFF]     ← 不發送（自己關閉）
  └─ 項目 3 [toggle: ON]      ← 會發送

=== 標題 B ===  [toggle: OFF]
  ├─ 項目 4 [toggle: ON]      ← 不發送（被父群組控制）+ 灰度效果
  ├─ 項目 5 [toggle: ON]      ← 不發送（被父群組控制）+ 灰度效果
  └─ 項目 6 [toggle: OFF]     ← 不發送（自己也關閉）+ 灰度效果
```

被關閉群組中的項目會以降低透明度顯示，表示它們受到群組標題控制。

### 設定選項

#### 設定面板選項

- **分隔符號**: 用於識別群組標題的自訂符號（每行一個）
- **區分大小寫**: 切換分隔符號比對的大小寫敏感度
- **摺疊模式**: 
  - 標準模式：從標題到標題的循序群組化
  - 包覆模式：配對標題的群組化

#### 除錯模式

若需啟用詳細日誌以進行疑難排解：

開啟瀏覽器主控台並執行：
```javascript
localStorage.setItem('mingyu_collapsible_debugMode', 'true');
```

重新載入頁面即可在主控台看到除錯輸出。

停用方式：
```javascript
localStorage.setItem('mingyu_collapsible_debugMode', 'false');
```

### 更新日誌

- 2025.11.17 - `2.2.1` - 修復純符號群組名新功能無效；修復同樣群組名功能混亂；新增更新日誌
- 2025.11.16 - `2.2.0` - 新增功能：群組關閉 prompt 發送
- 2025.11.07 - `2.1.1` - 更新 README.md；修復點擊 toggle 切換條目開關時摺疊也會一起行動的問題
- 2025.10.19 - `2.1.0` - 模式切換直接切換不需要按套用才切換
- 2025.10.19 - `2.0.0` - 所有代碼重構；儲存不到摺疊狀態的 bug fix
- 2025.10.18 - `1.3.0` - 新功能：漢堡模式，上下包覆才做分組
- 2025.10.17 - `1.2.3` - 修正標題名稱顯示邏輯，當作設定的符號現在依然會顯示在標題上
- 2025.10.17 - `1.2.2` - 更新按鈕提示與顯示文字
- 2025.10.17 - `1.2.1` - 改善邏輯；新增除錯 log
- 2025.10.17 - `1.2.0` - 調整按鈕組裝順序，將設定按鈕移至分組開關之後
- 2025.10.17 - `1.1.2` - 更新 README.md，改善提示詞分組功能的描述與使用方式
- 2025.10.17 - `1.1.1` - 新增設定面板，允許用戶自訂分組標示符號及大小寫選項；新增說明圖示樣式；修正預設分組標示符號；改善設定面板的插入位置與提示文字
- 2025.10.16 - `1.1.0` - PromptFolding 雛形完成
- 2025.10.15 - `1.0.0` - PromptFolding 誕生

### 技術細節

#### 架構設計

本擴充功能使用雙觀察器機制來處理 SillyTavern 的完整 DOM 重繪：

1. **容器觀察器**：監控提示詞列表容器的出現
2. **內容觀察器**：監控提示詞列表內的變化

此設計確保即使 SillyTavern 完全重繪介面，擴充功能仍能正常運作。

#### 狀態管理

- 群組展開狀態會持久化到 localStorage
- 自訂分隔符號設定依使用者儲存
- 摺疊模式偏好會跨工作階段記憶

### 相容性

- 需要支援提示詞管理器的 SillyTavern 版本
- 支援所有提示詞類型與生成模式
- 相容提示詞拖放功能

### 授權

MIT License

### 作者

mingyu

### 儲存庫

https://github.com/lilminzyu/ST-PromptFolding